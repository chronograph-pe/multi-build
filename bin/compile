#!/usr/bin/env bash

indent() {
    sed -u 's/^/       /'
}

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

PROCFILE=$(cat ${ENV_DIR}/PROCFILE)
NGINXCONF=$(cat ${ENV_DIR}/NGINXCONF)
POSTDEPLOY=$(cat ${ENV_DIR}/POSTDEPLOY)
HEROKU_APP_NAME=$(cat ${ENV_DIR}/HEROKU_APP_NAME)

echo "multi-build"
echo ${HEROKU_APP_NAME}

if [[ -z "${PROCFILE}" ]]; then
    echo "PROCFILE was not set. Aborting" | indent
    exit 1
fi

if [[ -z "${NGINXCONF}" ]]; then
    echo "NGINXCONF was not set. Aborting" | indent
    exit 1
fi

if [[ -z "${POSTDEPLOY}" ]]; then
    echo "POSTDEPLOY was not set. Aborting" | indent
    exit 1
fi

cp ${BUILD_DIR}/${PROCFILE} ${BUILD_DIR}/Procfile

if ! [ $? ]; then
    echo "FAILED to copy Procfile" | indent
    exit 1
fi

cp ${BUILD_DIR}/${NGINXCONF} ${BUILD_DIR}/config/nginx.conf.erb

if ! [ $? ]; then
    echo "FAILED to copy nginx.conf.erb" | indent
    exit 1
fi

cp ${BUILD_DIR}/${POSTDEPLOY} ${BUILD_DIR}/postdeploy.sh

if ! [ $? ]; then
    echo "FAILED to copy postdeploy.sh" | indent
    exit 1
fi

NGINX_BUILDPACK_DIR=$(mktemp -td nginx_buildpack.XXXXX)
NODEJS_BUILDPACK_DIR=$(mktemp -td nodejs_buildpack.XXXXX)

curl -Lk 'https://github.com/heroku/heroku-buildpack-nginx/archive/master.tar.gz' | tar xz -C "${NGINX_BUILDPACK_DIR}" --strip 1
curl -Lk 'https://github.com/heroku/heroku-buildpack-nodejs/archive/master.tar.gz' | tar xz -C "${NODEJS_BUILDPACK_DIR}" --strip 1

sh "${NGINX_BUILDPACK_DIR}/bin/compile" "${BUILD_DIR}" "${CACHE_DIR}" "${ENV_DIR}"

sh "${NODEJS_BUILDPACK_DIR}/bin/compile" "${BUILD_DIR}" "${CACHE_DIR}" "${ENV_DIR}"

echo "Copied successfully." | indent
